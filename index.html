<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·‘æ­¥æ•°æ®ç»Ÿè®¡å›¾è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .stat-card .unit {
            color: #999;
            font-size: 0.9em;
        }
        .chart-full-width {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            width: 100%;
        }
        .chart-full-width h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .chart-full-width .chart-wrapper {
            position: relative;
            height: 400px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .chart-container h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .data-table h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: #f8f9ff;
        }
        .highlight {
            background: #fff3cd;
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .filter-container label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        .filter-container label:hover {
            background: #e0e0e0;
        }
        .filter-container input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .filter-container .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .filter-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        .filter-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .filter-actions .btn-all {
            background: #667eea;
            color: white;
        }
        .filter-actions .btn-none {
            background: #e0e0e0;
            color: #333;
        }
        .filter-actions button:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }
        .month-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .month-filter button {
            padding: 8px 20px;
            border: 2px solid #667eea;
            border-radius: 20px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .month-filter button:hover {
            background: #f0f0ff;
        }
        .month-filter button.active {
            background: #667eea;
            color: white;
        }
        .medal-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .medal-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .medal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .month-medal-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }
        .month-medal-card h3 {
            color: #667eea;
            font-size: 1em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .medal-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .medal-row:last-child {
            border-bottom: none;
        }
        .medal-icon {
            font-size: 1.5em;
            margin-right: 10px;
            width: 30px;
        }
        .medal-name {
            flex: 1;
            font-weight: 500;
            color: #333;
        }
        .medal-distance {
            color: #666;
            font-size: 0.9em;
        }
        .medal-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .medal-summary-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid #f0f0f0;
            transition: all 0.2s;
        }
        .medal-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .medal-summary-card .name {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .medal-summary-card .medals {
            font-size: 1.2em;
            letter-spacing: 2px;
        }
        .medal-summary-card .total {
            color: #999;
            font-size: 0.8em;
            margin-top: 5px;
        }
        .weekly-goal-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .weekly-goal-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .goal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .goal-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #fff 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 2px solid #c8e6c9;
        }
        .goal-card .name {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
        }
        .goal-card .count {
            font-size: 2em;
            font-weight: bold;
            color: #1b5e20;
        }
        .goal-card .label {
            color: #666;
            font-size: 0.85em;
        }
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 1.8em;
            }
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .collapsible-header h2 {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }
        .collapsible-header .toggle-icon {
            font-size: 1.5em;
            transition: transform 0.3s;
        }
        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.collapsed {
            max-height: 0 !important;
        }
        .export-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 1000;
        }
        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .export-btn:active {
            transform: translateY(0);
        }
        .person-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .person-filter button {
            padding: 6px 14px;
            border: 2px solid #667eea;
            border-radius: 20px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .person-filter button:hover {
            background: #f0f0ff;
        }
        .person-filter button.active {
            background: #667eea;
            color: white;
        }
        .add-data-btn {
            position: fixed;
            bottom: 30px;
            right: 150px;
            background: linear-gradient(135deg, #1ABC9C 0%, #16A085 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 1000;
        }
        .add-data-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal.wide {
            max-width: 700px;
        }
        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .modal-close {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }
        .modal-close:hover {
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }
        .form-group textarea {
            font-family: monospace;
            resize: vertical;
            min-height: 150px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .form-actions button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d6;
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .copy-success {
            color: #1ABC9C;
            font-weight: 600;
            margin-top: 10px;
            display: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-overlay.hidden {
            display: none;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 1.2em;
        }
        .config-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 0.9em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 1000;
        }
        .config-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .batch-import-btn {
            position: fixed;
            bottom: 30px;
            right: 270px;
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 1000;
        }
        .batch-import-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .import-preview {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .import-preview-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }
        .import-preview-item:last-child {
            border-bottom: none;
        }
        .import-preview-item.valid {
            color: #27ae60;
        }
        .import-preview-item.invalid {
            color: #e74c3c;
        }
        .import-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 8px;
        }
        .import-stats span {
            font-weight: 600;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected {
            background: #27ae60;
        }
        .status-disconnected {
            background: #e74c3c;
        }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 0.85em;
            z-index: 1000;
        }
        .format-help {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.85em;
        }
        .format-help code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <h1>ğŸƒ 2025å¹´è·‘æ­¥æ•°æ®ç»Ÿè®¡</h1>

        <div class="stats-summary" id="statsSummary"></div>

        <div class="chart-full-width">
            <h2>ğŸ“… æ¯å‘¨è·‘æ­¥é‡Œç¨‹ç»Ÿè®¡ï¼ˆå †ç§¯å›¾ï¼‰</h2>
            <div id="stackedFilter" class="filter-container"></div>
            <div class="chart-wrapper">
                <canvas id="weeklyStackedChart"></canvas>
            </div>
        </div>

        <div class="weekly-goal-section">
            <h2>ğŸ¯ æ¯å‘¨è¾¾æ ‡ç»Ÿè®¡ï¼ˆå‘¨ç›®æ ‡: 3km+ï¼‰</h2>
            <div class="goal-grid" id="weeklyGoalStats"></div>
        </div>

        <div class="medal-section">
            <h2>ğŸ† æœˆåº¦é‡Œç¨‹æ’è¡Œæ¦œ</h2>
            <div class="medal-grid" id="monthlyMedals"></div>
            <h3 style="margin-top: 25px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px;">å¥–ç‰Œæ€»æ¦œ</h3>
            <div class="medal-summary" id="medalSummary"></div>
        </div>

        <div class="chart-full-width">
            <h2>ğŸ“ˆ æ¯å‘¨ä¸ªäººè·‘æ­¥è·ç¦»å˜åŒ–</h2>
            <div id="trendFilter" class="filter-container"></div>
            <div class="chart-wrapper">
                <canvas id="weeklyTrendChart"></canvas>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h2>ğŸ“Š ä¸ªäººæ€»é‡Œç¨‹æ’è¡Œ</h2>
                <div class="chart-wrapper">
                    <canvas id="totalDistanceChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>ğŸ¯ ä¸ªäººè·‘æ­¥æ¬¡æ•°</h2>
                <div class="chart-wrapper">
                    <canvas id="runCountChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table">
            <div class="collapsible-header collapsed" onclick="toggleDataTable()">
                <h2>ğŸ“‹ å®Œæ•´æ•°æ®è®°å½•</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="dataTableContent">
                <div style="border-top: 2px solid #667eea; margin-top: 10px; padding-top: 20px;">
                    <div id="monthFilter" class="month-filter"></div>
                    <div id="personFilter" class="person-filter"></div>
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>å§“å</th>
                                <th>æ—¥æœŸ</th>
                                <th>è·ç¦» (km)</th>
                                <th>å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <button class="add-data-btn" onclick="openAddDataModal()">+ æ·»åŠ æ•°æ®</button>
        <button class="batch-import-btn" onclick="openBatchImportModal()">ğŸ“¥ æ‰¹é‡å¯¼å…¥</button>
        <button class="export-btn" onclick="exportToImage()">ğŸ“· å¯¼å‡ºå›¾ç‰‡</button>
        <button class="config-btn" onclick="openConfigModal()">âš™ï¸ é…ç½®</button>
    </div>

    <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="connection-status" id="connectionStatus">
        <span class="status-indicator status-disconnected" id="statusIndicator"></span>
        <span id="statusText">æœªè¿æ¥</span>
    </div>

    <!-- åŠ è½½ä¸­é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">åŠ è½½æ•°æ®ä¸­...</div>
    </div>

    <!-- æ·»åŠ æ•°æ®å¼¹çª— -->
    <div class="modal-overlay" id="addDataModal">
        <div class="modal">
            <span class="modal-close" onclick="closeAddDataModal()">&times;</span>
            <h2>æ·»åŠ è·‘æ­¥æ•°æ®</h2>
            <div class="form-group">
                <label>å§“å</label>
                <select id="inputName">
                    <option value="">-- é€‰æ‹©æˆ–è¾“å…¥æ–°åå­— --</option>
                </select>
            </div>
            <div class="form-group">
                <label>æˆ–è¾“å…¥æ–°åå­—</label>
                <input type="text" id="inputNewName" placeholder="å¦‚æœæ˜¯æ–°æˆå‘˜ï¼Œåœ¨æ­¤è¾“å…¥">
            </div>
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="inputDate" value="">
            </div>
            <div class="form-group">
                <label>è·ç¦» (km)</label>
                <input type="number" id="inputDistance" step="0.01" min="0" placeholder="ä¾‹å¦‚: 5.5">
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨ (å¯é€‰)</label>
                <input type="text" id="inputNote" placeholder="ä¾‹å¦‚: w10">
            </div>
            <div class="form-actions">
                <button class="btn-secondary" onclick="closeAddDataModal()">å–æ¶ˆ</button>
                <button class="btn-primary" id="saveDataBtn" onclick="saveData()">ä¿å­˜æ•°æ®</button>
            </div>
            <div class="success-message" id="addSuccess">æ•°æ®æ·»åŠ æˆåŠŸ!</div>
            <div class="error-message" id="addError"></div>
        </div>
    </div>

    <!-- æ‰¹é‡å¯¼å…¥å¼¹çª— -->
    <div class="modal-overlay" id="batchImportModal">
        <div class="modal wide">
            <span class="modal-close" onclick="closeBatchImportModal()">&times;</span>
            <h2>æ‰¹é‡å¯¼å…¥æ•°æ®</h2>
            <div class="format-help">
                <strong>æ ¼å¼è¯´æ˜ï¼š</strong>æ¯è¡Œä¸€æ¡æ•°æ®ï¼Œä½¿ç”¨é€—å·æˆ–ç©ºæ ¼åˆ†éš”<br>
                æ ¼å¼: <code>å§“å, æ—¥æœŸ(MMDDæˆ–MM-DDæˆ–MæœˆDæ—¥), è·ç¦», å¤‡æ³¨(å¯é€‰)</code><br>
                ç¤ºä¾‹:<br>
                <code>å¾å²š, 1220, 5.5</code><br>
                <code>æ–¹æ–‡, 12-21, 10, å‘¨æœ«è®­ç»ƒ</code><br>
                <code>æ¢æ™¨, 12æœˆ22æ—¥, 3.5</code>
            </div>
            <div class="form-group">
                <label>æ‰¹é‡æ•°æ®</label>
                <textarea id="batchInput" placeholder="ç²˜è´´æ•°æ®åˆ°è¿™é‡Œï¼Œæ¯è¡Œä¸€æ¡..."></textarea>
            </div>
            <button class="btn-secondary" onclick="previewBatchData()" style="width: 100%; margin-bottom: 10px;">é¢„è§ˆæ•°æ®</button>
            <div id="batchPreview" class="import-preview" style="display: none;"></div>
            <div id="batchStats" class="import-stats" style="display: none;"></div>
            <div class="form-actions">
                <button class="btn-secondary" onclick="closeBatchImportModal()">å–æ¶ˆ</button>
                <button class="btn-primary" id="batchImportBtn" onclick="executeBatchImport()" disabled>å¯¼å…¥æ•°æ®</button>
            </div>
            <div class="success-message" id="batchSuccess"></div>
            <div class="error-message" id="batchError"></div>
        </div>
    </div>

    <!-- é…ç½®å¼¹çª— -->
    <div class="modal-overlay" id="configModal">
        <div class="modal">
            <span class="modal-close" onclick="closeConfigModal()">&times;</span>
            <h2>Supabase é…ç½®</h2>
            <div class="format-help">
                <strong>è®¾ç½®è¯´æ˜ï¼š</strong><br>
                1. ç™»å½• <a href="https://supabase.com" target="_blank">Supabase</a> åˆ›å»ºé¡¹ç›®<br>
                2. åœ¨ Settings > API ä¸­è·å– URL å’Œ anon key<br>
                3. åœ¨ SQL Editor ä¸­è¿è¡Œä»¥ä¸‹SQLåˆ›å»ºè¡¨ï¼š
                <pre style="background: #f8f9fa; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 0.8em; overflow-x: auto;">
CREATE TABLE running_records (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  date TEXT NOT NULL,
  distance NUMERIC NOT NULL,
  unit TEXT DEFAULT 'km',
  note TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- å…è®¸åŒ¿åè®¿é—®
ALTER TABLE running_records ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow all" ON running_records FOR ALL USING (true);</pre>
            </div>
            <div class="form-group">
                <label>Supabase URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://xxx.supabase.co">
            </div>
            <div class="form-group">
                <label>Supabase Anon Key</label>
                <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6...">
            </div>
            <div class="form-actions">
                <button class="btn-secondary" onclick="closeConfigModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            </div>
            <div class="success-message" id="configSuccess">é…ç½®ä¿å­˜æˆåŠŸ!</div>
            <div class="error-message" id="configError"></div>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
            <button class="btn-danger" onclick="clearConfig()" style="width: 100%;">æ¸…é™¤é…ç½®ï¼ˆä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰</button>
        </div>
    </div>

    <script>
        // ============== Supabase é…ç½® ==============
        let supabaseClient = null;
        let isConnected = false;

        // æœ¬åœ°å¤‡ä»½æ•°æ®
        const localData = [
            { id: 1, name: 'æ¨é–', date: '0114', distance: 6, unit: 'km' },
            { id: 2, name: 'é™ˆå³¥åµ˜', date: '0114', distance: 1, unit: 'km' },
            { id: 3, name: 'å¾å²š', date: '0114', distance: 6.5, unit: 'km' },
            { id: 4, name: 'é©¬æ–‡é›…', date: '0115', distance: 2, unit: 'km' },
            { id: 5, name: 'é™ˆå³¥åµ˜', date: '0115', distance: 3, unit: 'km', note: 'w1' },
            { id: 6, name: 'æ¢æ™¨', date: '0116', distance: 2, unit: 'km' },
            { id: 7, name: 'chuchu', date: '0116', distance: 4.11, unit: 'km' },
            { id: 8, name: 'é™ˆå³¥åµ˜', date: '0115', distance: 1, unit: 'km', note: 'w1' },
            { id: 9, name: 'å¾å²š', date: '0116', distance: 7, unit: 'km' },
            { id: 10, name: 'æ–¹æ–‡', date: '0116', distance: 5, unit: 'km' },
            { id: 31, name: 'å¾å²š', date: '0921', distance: 10.18, unit: 'km' },
            { id: 32, name: 'å¾å²š', date: '0923', distance: 5.07, unit: 'km' },
            { id: 33, name: 'å¾å²š', date: '0925', distance: 5.02, unit: 'km' },
            { id: 34, name: 'å¾å²š', date: '0928', distance: 5.08, unit: 'km' },
            { id: 35, name: 'å¾å²š', date: '0929', distance: 5.32, unit: 'km' }
        ];

        // å®é™…ä½¿ç”¨çš„æ•°æ®
        let rawData = [];

        // ============== åˆå§‹åŒ– ==============
        async function initApp() {
            showLoading('åˆå§‹åŒ–ä¸­...');

            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„é…ç½®
            const savedUrl = localStorage.getItem('supabase_url');
            const savedKey = localStorage.getItem('supabase_key');

            if (savedUrl && savedKey) {
                document.getElementById('supabaseUrl').value = savedUrl;
                document.getElementById('supabaseKey').value = savedKey;
                await connectToSupabase(savedUrl, savedKey);
            } else {
                // ä½¿ç”¨æœ¬åœ°æ•°æ®
                rawData = [...localData];
                updateConnectionStatus(false);
            }

            // æ¸²æŸ“é¡µé¢
            renderAll();
            hideLoading();
        }

        // è¿æ¥Supabase
        async function connectToSupabase(url, key) {
            try {
                showLoading('è¿æ¥æ•°æ®åº“...');
                supabaseClient = supabase.createClient(url, key);

                // æµ‹è¯•è¿æ¥å¹¶è·å–æ•°æ®
                const { data, error } = await supabaseClient
                    .from('running_records')
                    .select('*')
                    .order('id', { ascending: true });

                if (error) throw error;

                rawData = data || [];
                isConnected = true;
                updateConnectionStatus(true);
                console.log('Supabase è¿æ¥æˆåŠŸï¼ŒåŠ è½½äº†', rawData.length, 'æ¡è®°å½•');

            } catch (err) {
                console.error('Supabase è¿æ¥å¤±è´¥:', err);
                rawData = [...localData];
                isConnected = false;
                updateConnectionStatus(false);
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = 'å·²è¿æ¥ Supabase';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = 'æœ¬åœ°æ¨¡å¼';
            }
        }

        // æ˜¾ç¤º/éšè—åŠ è½½
        function showLoading(text = 'åŠ è½½ä¸­...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ============== é…ç½®ç®¡ç† ==============
        function openConfigModal() {
            document.getElementById('configModal').classList.add('active');
            document.getElementById('configSuccess').style.display = 'none';
            document.getElementById('configError').style.display = 'none';
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        async function saveConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();

            if (!url || !key) {
                document.getElementById('configError').textContent = 'è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯';
                document.getElementById('configError').style.display = 'block';
                return;
            }

            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);

            await connectToSupabase(url, key);

            if (isConnected) {
                document.getElementById('configSuccess').style.display = 'block';
                document.getElementById('configError').style.display = 'none';
                renderAll();
                setTimeout(closeConfigModal, 1500);
            } else {
                document.getElementById('configError').textContent = 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ä¿¡æ¯';
                document.getElementById('configError').style.display = 'block';
            }
        }

        function clearConfig() {
            localStorage.removeItem('supabase_url');
            localStorage.removeItem('supabase_key');
            supabaseClient = null;
            isConnected = false;
            rawData = [...localData];
            updateConnectionStatus(false);
            renderAll();
            closeConfigModal();
        }

        // ============== æ•°æ®æ“ä½œ ==============
        // æ·»åŠ å•æ¡æ•°æ®
        async function saveData() {
            const selectName = document.getElementById('inputName').value;
            const newName = document.getElementById('inputNewName').value.trim();
            const dateInput = document.getElementById('inputDate').value;
            const distance = parseFloat(document.getElementById('inputDistance').value);
            const note = document.getElementById('inputNote').value.trim();

            const name = newName || selectName;
            if (!name) {
                showAddError('è¯·é€‰æ‹©æˆ–è¾“å…¥å§“å');
                return;
            }
            if (!dateInput) {
                showAddError('è¯·é€‰æ‹©æ—¥æœŸ');
                return;
            }
            if (isNaN(distance) || distance < 0) {
                showAddError('è¯·è¾“å…¥æœ‰æ•ˆçš„è·ç¦»');
                return;
            }

            // è½¬æ¢æ—¥æœŸæ ¼å¼
            const dateParts = dateInput.split('-');
            const dateCode = dateParts[1] + dateParts[2];

            const newRecord = {
                name: name,
                date: dateCode,
                distance: distance,
                unit: 'km',
                note: note || null
            };

            if (isConnected && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('running_records')
                        .insert([newRecord])
                        .select();

                    if (error) throw error;

                    rawData.push(data[0]);
                    showAddSuccess();
                    renderAll();

                } catch (err) {
                    showAddError('ä¿å­˜å¤±è´¥: ' + err.message);
                    return;
                }
            } else {
                // æœ¬åœ°æ¨¡å¼
                const maxId = rawData.length > 0 ? Math.max(...rawData.map(r => r.id)) : 0;
                newRecord.id = maxId + 1;
                rawData.push(newRecord);
                showAddSuccess();
                renderAll();
            }
        }

        function showAddSuccess() {
            document.getElementById('addSuccess').style.display = 'block';
            document.getElementById('addError').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('inputNewName').value = '';
            document.getElementById('inputDistance').value = '';
            document.getElementById('inputNote').value = '';
            setTimeout(() => {
                document.getElementById('addSuccess').style.display = 'none';
            }, 2000);
        }

        function showAddError(msg) {
            document.getElementById('addError').textContent = msg;
            document.getElementById('addError').style.display = 'block';
            document.getElementById('addSuccess').style.display = 'none';
        }

        // ============== æ‰¹é‡å¯¼å…¥ ==============
        let parsedBatchData = [];

        function openBatchImportModal() {
            document.getElementById('batchImportModal').classList.add('active');
            document.getElementById('batchInput').value = '';
            document.getElementById('batchPreview').style.display = 'none';
            document.getElementById('batchStats').style.display = 'none';
            document.getElementById('batchImportBtn').disabled = true;
            document.getElementById('batchSuccess').style.display = 'none';
            document.getElementById('batchError').style.display = 'none';
            parsedBatchData = [];
        }

        function closeBatchImportModal() {
            document.getElementById('batchImportModal').classList.remove('active');
        }

        function parseDate(dateStr) {
            dateStr = dateStr.trim();

            // æ ¼å¼: MMDD (å¦‚ 1220)
            if (/^\d{4}$/.test(dateStr)) {
                return dateStr;
            }

            // æ ¼å¼: MM-DD æˆ– M-D (å¦‚ 12-20 æˆ– 1-5)
            let match = dateStr.match(/^(\d{1,2})-(\d{1,2})$/);
            if (match) {
                return match[1].padStart(2, '0') + match[2].padStart(2, '0');
            }

            // æ ¼å¼: MæœˆDæ—¥ (å¦‚ 12æœˆ20æ—¥)
            match = dateStr.match(/^(\d{1,2})æœˆ(\d{1,2})æ—¥?$/);
            if (match) {
                return match[1].padStart(2, '0') + match[2].padStart(2, '0');
            }

            return null;
        }

        function parseBatchLine(line) {
            line = line.trim();
            if (!line) return null;

            // æ”¯æŒé€—å·æˆ–å¤šä¸ªç©ºæ ¼åˆ†éš”
            const parts = line.split(/[,ï¼Œ]\s*|\s{2,}/).map(p => p.trim()).filter(p => p);

            if (parts.length < 3) return null;

            const name = parts[0];
            const date = parseDate(parts[1]);
            const distance = parseFloat(parts[2]);
            const note = parts[3] || null;

            if (!name || !date || isNaN(distance)) return null;

            return { name, date, distance, unit: 'km', note };
        }

        function previewBatchData() {
            const input = document.getElementById('batchInput').value;
            const lines = input.split('\n');

            parsedBatchData = [];
            let validCount = 0;
            let invalidCount = 0;
            let previewHtml = '';

            lines.forEach((line, index) => {
                if (!line.trim()) return;

                const parsed = parseBatchLine(line);
                if (parsed) {
                    parsedBatchData.push(parsed);
                    validCount++;
                    previewHtml += `<div class="import-preview-item valid">âœ“ ${parsed.name} | ${formatDate(parsed.date)} | ${parsed.distance}km${parsed.note ? ' | ' + parsed.note : ''}</div>`;
                } else {
                    invalidCount++;
                    previewHtml += `<div class="import-preview-item invalid">âœ— ç¬¬${index + 1}è¡Œæ ¼å¼é”™è¯¯: ${line}</div>`;
                }
            });

            document.getElementById('batchPreview').innerHTML = previewHtml || '<div>æ²¡æœ‰å¯é¢„è§ˆçš„æ•°æ®</div>';
            document.getElementById('batchPreview').style.display = 'block';
            document.getElementById('batchStats').innerHTML = `<span>æœ‰æ•ˆ: ${validCount}æ¡</span><span>æ— æ•ˆ: ${invalidCount}æ¡</span>`;
            document.getElementById('batchStats').style.display = 'flex';
            document.getElementById('batchImportBtn').disabled = validCount === 0;
        }

        async function executeBatchImport() {
            if (parsedBatchData.length === 0) return;

            showLoading('æ­£åœ¨å¯¼å…¥æ•°æ®...');

            if (isConnected && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('running_records')
                        .insert(parsedBatchData)
                        .select();

                    if (error) throw error;

                    rawData.push(...data);
                    document.getElementById('batchSuccess').textContent = `æˆåŠŸå¯¼å…¥ ${data.length} æ¡æ•°æ®!`;
                    document.getElementById('batchSuccess').style.display = 'block';

                } catch (err) {
                    document.getElementById('batchError').textContent = 'å¯¼å…¥å¤±è´¥: ' + err.message;
                    document.getElementById('batchError').style.display = 'block';
                    hideLoading();
                    return;
                }
            } else {
                // æœ¬åœ°æ¨¡å¼
                let maxId = rawData.length > 0 ? Math.max(...rawData.map(r => r.id)) : 0;
                parsedBatchData.forEach(record => {
                    record.id = ++maxId;
                    rawData.push(record);
                });
                document.getElementById('batchSuccess').textContent = `æˆåŠŸå¯¼å…¥ ${parsedBatchData.length} æ¡æ•°æ®!`;
                document.getElementById('batchSuccess').style.display = 'block';
            }

            renderAll();
            hideLoading();

            // æ¸…ç©ºå¹¶å…³é—­
            setTimeout(() => {
                closeBatchImportModal();
            }, 1500);
        }

        // ============== æ·»åŠ æ•°æ®å¼¹çª— ==============
        function openAddDataModal() {
            const modal = document.getElementById('addDataModal');
            modal.classList.add('active');

            // å¡«å……äººå‘˜ä¸‹æ‹‰æ¡†
            const select = document.getElementById('inputName');
            const persons = [...new Set(rawData.map(item => item.name))].sort();
            select.innerHTML = '<option value="">-- é€‰æ‹©å·²æœ‰æˆå‘˜ --</option>';
            persons.forEach(person => {
                select.innerHTML += `<option value="${person}">${person}</option>`;
            });

            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inputDate').value = today;

            // æ¸…ç©ºå…¶ä»–å­—æ®µ
            document.getElementById('inputNewName').value = '';
            document.getElementById('inputDistance').value = '';
            document.getElementById('inputNote').value = '';
            document.getElementById('addSuccess').style.display = 'none';
            document.getElementById('addError').style.display = 'none';
        }

        function closeAddDataModal() {
            document.getElementById('addDataModal').classList.remove('active');
        }

        // ============== å›¾è¡¨å’Œç»Ÿè®¡ ==============
        let weeklyStackedChart = null;
        let weeklyTrendChart = null;
        let totalDistanceChart = null;
        let runCountChart = null;

        const filterState = {
            stacked: {},
            trend: {}
        };

        function formatDate(dateStr) {
            const month = dateStr.substring(0, 2);
            const day = dateStr.substring(2, 4);
            return `${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
        }

        const personColors = {
            'å¾å²š': '#FF6384',
            'æ–¹æ–‡': '#36A2EB',
            'é™ˆå¾·ç´': '#FFCE56',
            'ææ–‡æ¶›': '#4BC0C0',
            'æ¢æ™¨': '#9966FF',
            'é™ˆå³¥åµ˜': '#FF9F40',
            'chuchu': '#7BC225',
            'å²å­Ÿä¸½': '#E74C3C',
            'å®‰è¿ª': '#3498DB',
            'æ¨é–': '#1ABC9C',
            'å¼ åª›åª›': '#333333',
            'é©¬æ–‡é›…': '#8E44AD'
        };

        function getPersonColor(name) {
            return personColors[name] || '#C9CBCF';
        }

        function calculateStats() {
            if (rawData.length === 0) return { totalDistance: 0, totalRuns: 0, uniqueRunners: 0, avgDistance: 0, maxDistance: 0 };

            const totalDistance = rawData.reduce((sum, item) => sum + item.distance, 0);
            const totalRuns = rawData.length;
            const uniqueRunners = [...new Set(rawData.map(item => item.name))].length;
            const avgDistance = totalDistance / totalRuns;
            const maxDistance = Math.max(...rawData.map(item => item.distance));

            return { totalDistance, totalRuns, uniqueRunners, avgDistance, maxDistance };
        }

        function renderStatsSummary() {
            const stats = calculateStats();
            const container = document.getElementById('statsSummary');

            container.innerHTML = `
                <div class="stat-card">
                    <h3>æ€»é‡Œç¨‹</h3>
                    <div class="value">${stats.totalDistance.toFixed(2)}</div>
                    <div class="unit">å…¬é‡Œ</div>
                </div>
                <div class="stat-card">
                    <h3>è·‘æ­¥æ¬¡æ•°</h3>
                    <div class="value">${stats.totalRuns}</div>
                    <div class="unit">æ¬¡</div>
                </div>
                <div class="stat-card">
                    <h3>å‚ä¸äººæ•°</h3>
                    <div class="value">${stats.uniqueRunners}</div>
                    <div class="unit">äºº</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡æ¯æ¬¡</h3>
                    <div class="value">${stats.avgDistance.toFixed(2)}</div>
                    <div class="unit">å…¬é‡Œ</div>
                </div>
                <div class="stat-card">
                    <h3>å•æ¬¡æœ€é•¿</h3>
                    <div class="value">${stats.maxDistance}</div>
                    <div class="unit">å…¬é‡Œ</div>
                </div>
            `;
        }

        function getPersonalTotals() {
            const totals = {};
            rawData.forEach(item => {
                if (!totals[item.name]) totals[item.name] = 0;
                totals[item.name] += item.distance;
            });
            return Object.entries(totals)
                .sort((a, b) => b[1] - a[1])
                .map(([name, distance]) => ({ name, distance }));
        }

        function getRunCounts() {
            const counts = {};
            rawData.forEach(item => {
                if (!counts[item.name]) counts[item.name] = 0;
                counts[item.name]++;
            });
            return Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .map(([name, count]) => ({ name, count }));
        }

        function getWeekNumber(dateStr) {
            const month = parseInt(dateStr.substring(0, 2));
            const day = parseInt(dateStr.substring(2, 4));
            const date = new Date(2025, month - 1, day);

            const target = new Date(date.valueOf());
            const dayNr = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNr + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        function getWeeklyDataByPerson() {
            const weeklyData = {};
            const allPersons = [...new Set(rawData.map(item => item.name))];

            const personTotals = {};
            allPersons.forEach(person => personTotals[person] = 0);
            rawData.forEach(item => personTotals[item.name] += item.distance);

            const sortedPersons = allPersons.sort((a, b) => personTotals[b] - personTotals[a]);

            rawData.forEach(item => {
                const weekNum = getWeekNumber(item.date);
                const weekLabel = `ç¬¬${weekNum}å‘¨`;

                if (!weeklyData[weekLabel]) {
                    weeklyData[weekLabel] = {};
                    sortedPersons.forEach(person => weeklyData[weekLabel][person] = 0);
                }
                weeklyData[weekLabel][item.name] += item.distance;
            });

            const sortedWeeks = Object.keys(weeklyData).sort((a, b) => {
                const numA = parseInt(a.match(/\d+/)[0]);
                const numB = parseInt(b.match(/\d+/)[0]);
                return numA - numB;
            });

            return { weeks: sortedWeeks, data: weeklyData, persons: sortedPersons };
        }

        function createFilter(containerId, filterType, persons) {
            const container = document.getElementById(containerId);

            persons.forEach(person => {
                if (filterState[filterType][person] === undefined) {
                    filterState[filterType][person] = true;
                }
            });

            let html = '';
            persons.forEach(person => {
                const checked = filterState[filterType][person] ? 'checked' : '';
                const color = getPersonColor(person);
                html += `
                    <label>
                        <input type="checkbox" data-person="${person}" data-type="${filterType}" ${checked}>
                        <span class="color-dot" style="background: ${color}"></span>
                        ${person}
                    </label>
                `;
            });

            html += `
                <div class="filter-actions">
                    <button class="btn-all" data-type="${filterType}">å…¨é€‰</button>
                    <button class="btn-none" data-type="${filterType}">æ¸…ç©º</button>
                </div>
            `;

            container.innerHTML = html;

            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    filterState[e.target.dataset.type][e.target.dataset.person] = e.target.checked;
                    updateChart(e.target.dataset.type);
                });
            });

            container.querySelector('.btn-all').addEventListener('click', () => {
                persons.forEach(p => filterState[filterType][p] = true);
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateChart(filterType);
            });

            container.querySelector('.btn-none').addEventListener('click', () => {
                persons.forEach(p => filterState[filterType][p] = false);
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateChart(filterType);
            });
        }

        function updateChart(type) {
            if (type === 'stacked') renderWeeklyStackedChart();
            else if (type === 'trend') renderWeeklyTrendChart();
        }

        function renderWeeklyStackedChart() {
            if (rawData.length === 0) return;

            const { weeks, data, persons } = getWeeklyDataByPerson();

            if (!document.querySelector('#stackedFilter input')) {
                createFilter('stackedFilter', 'stacked', persons);
            }

            const filteredPersons = persons.filter(p => filterState.stacked[p]);
            const ctx = document.getElementById('weeklyStackedChart').getContext('2d');

            if (weeklyStackedChart) weeklyStackedChart.destroy();

            const datasets = filteredPersons.map(person => ({
                label: person,
                data: weeks.map(week => data[week][person]),
                backgroundColor: getPersonColor(person),
                borderColor: getPersonColor(person),
                borderWidth: 1,
                borderRadius: 4
            }));

            weeklyStackedChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: weeks, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.raw === 0 ? null : `${ctx.dataset.label}: ${ctx.raw.toFixed(2)} km`,
                                footer: items => `æœ¬å‘¨æ€»è®¡: ${items.reduce((s, i) => s + i.raw, 0).toFixed(2)} km`
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'å‘¨æ¬¡' } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'å…¬é‡Œ (km)' } }
                    }
                }
            });
        }

        function renderTotalDistanceChart() {
            if (rawData.length === 0) return;

            const data = getPersonalTotals();
            const ctx = document.getElementById('totalDistanceChart').getContext('2d');

            if (totalDistanceChart) totalDistanceChart.destroy();

            totalDistanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'æ€»é‡Œç¨‹ (km)',
                        data: data.map(d => d.distance),
                        backgroundColor: data.map(d => getPersonColor(d.name)),
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'å…¬é‡Œ (km)' } } }
                }
            });
        }

        function renderRunCountChart() {
            if (rawData.length === 0) return;

            const data = getRunCounts();
            const ctx = document.getElementById('runCountChart').getContext('2d');

            if (runCountChart) runCountChart.destroy();

            runCountChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'è·‘æ­¥æ¬¡æ•°',
                        data: data.map(d => d.count),
                        backgroundColor: data.map(d => getPersonColor(d.name) + '99'),
                        borderColor: data.map(d => getPersonColor(d.name)),
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'æ¬¡æ•°' } } }
                }
            });
        }

        function renderWeeklyTrendChart() {
            if (rawData.length === 0) return;

            const { weeks, data, persons } = getWeeklyDataByPerson();

            if (!document.querySelector('#trendFilter input')) {
                createFilter('trendFilter', 'trend', persons);
            }

            const filteredPersons = persons.filter(p => filterState.trend[p]);
            const ctx = document.getElementById('weeklyTrendChart').getContext('2d');

            if (weeklyTrendChart) weeklyTrendChart.destroy();

            const datasets = filteredPersons.map(person => ({
                label: person,
                data: weeks.map(week => data[week][person] || 0),
                borderColor: getPersonColor(person),
                backgroundColor: getPersonColor(person) + '33',
                fill: false,
                tension: 0.3,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: getPersonColor(person),
                borderWidth: 3
            }));

            weeklyTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: weeks, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.raw === 0 ? `${ctx.dataset.label}: æœªè·‘æ­¥` : `${ctx.dataset.label}: ${ctx.raw.toFixed(2)} km`
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'å‘¨æ¬¡' } },
                        y: { beginAtZero: true, title: { display: true, text: 'å…¬é‡Œ (km)' } }
                    }
                }
            });
        }

        // ============== æ•°æ®è¡¨æ ¼å’Œç­›é€‰ ==============
        let currentMonthFilter = 'all';
        let currentPersonFilter = 'all';

        function getMonthName(monthNum) {
            const months = { '01': '1æœˆ', '02': '2æœˆ', '03': '3æœˆ', '04': '4æœˆ', '05': '5æœˆ', '06': '6æœˆ', '07': '7æœˆ', '08': '8æœˆ', '09': '9æœˆ', '10': '10æœˆ', '11': '11æœˆ', '12': '12æœˆ' };
            return months[monthNum] || monthNum + 'æœˆ';
        }

        function createMonthFilter() {
            const container = document.getElementById('monthFilter');
            const months = [...new Set(rawData.map(item => item.date.substring(0, 2)))].sort();

            let html = '<button class="active" data-month="all">å…¨éƒ¨</button>';
            months.forEach(month => html += `<button data-month="${month}">${getMonthName(month)}</button>`);

            container.innerHTML = html;

            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    container.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentMonthFilter = e.target.dataset.month;
                    renderDataTable();
                });
            });
        }

        function createPersonFilter() {
            const container = document.getElementById('personFilter');
            const persons = [...new Set(rawData.map(item => item.name))].sort();

            let html = '<button class="active" data-person="all">å…¨éƒ¨æˆå‘˜</button>';
            persons.forEach(person => html += `<button data-person="${person}">${person}</button>`);

            container.innerHTML = html;

            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    container.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentPersonFilter = e.target.dataset.person;
                    renderDataTable();
                });
            });
        }

        function renderDataTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            let filteredData = rawData;
            if (currentMonthFilter !== 'all') {
                filteredData = filteredData.filter(item => item.date.substring(0, 2) === currentMonthFilter);
            }
            if (currentPersonFilter !== 'all') {
                filteredData = filteredData.filter(item => item.name === currentPersonFilter);
            }

            filteredData.forEach(item => {
                const row = document.createElement('tr');
                if (item.note) row.classList.add('highlight');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>2025å¹´${formatDate(item.date)}</td>
                    <td>${item.distance.toFixed(2)}</td>
                    <td>${item.note || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ============== ç›®æ ‡å’Œå¥–ç‰Œç»Ÿè®¡ ==============
        function getWeeklyGoalStats() {
            const { weeks, data, persons } = getWeeklyDataByPerson();
            const goalCounts = {};

            persons.forEach(person => {
                goalCounts[person] = 0;
                weeks.forEach(week => {
                    if (data[week][person] >= 3) goalCounts[person]++;
                });
            });

            return Object.entries(goalCounts)
                .filter(([name, count]) => count > 0)
                .sort((a, b) => b[1] - a[1])
                .map(([name, count]) => ({ name, count }));
        }

        function renderWeeklyGoalStats() {
            const data = getWeeklyGoalStats();
            document.getElementById('weeklyGoalStats').innerHTML = data.map(d => `
                <div class="goal-card">
                    <div class="name">${d.name}</div>
                    <div class="count">${d.count}</div>
                    <div class="label">å‘¨è¾¾æ ‡</div>
                </div>
            `).join('');
        }

        function getMonthlyMedals() {
            const monthlyData = {};
            const months = [...new Set(rawData.map(item => item.date.substring(0, 2)))].sort();

            months.forEach(month => monthlyData[month] = {});

            rawData.forEach(item => {
                const month = item.date.substring(0, 2);
                if (!monthlyData[month][item.name]) monthlyData[month][item.name] = 0;
                monthlyData[month][item.name] += item.distance;
            });

            const monthlyRankings = {};
            months.forEach(month => {
                monthlyRankings[month] = Object.entries(monthlyData[month])
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([name, distance], index) => ({
                        name,
                        distance,
                        medal: index === 0 ? 'ğŸ…' : index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'
                    }));
            });

            return { months, rankings: monthlyRankings };
        }

        function getMedalSummary() {
            const { months, rankings } = getMonthlyMedals();
            const medalCounts = {};

            months.forEach(month => {
                rankings[month].forEach((entry, index) => {
                    if (!medalCounts[entry.name]) medalCounts[entry.name] = { gold: 0, silver: 0, bronze: 0 };
                    if (index === 0) medalCounts[entry.name].gold++;
                    else if (index === 1) medalCounts[entry.name].silver++;
                    else if (index === 2) medalCounts[entry.name].bronze++;
                });
            });

            return Object.entries(medalCounts)
                .map(([name, medals]) => ({
                    name,
                    ...medals,
                    total: medals.gold * 3 + medals.silver * 2 + medals.bronze
                }))
                .sort((a, b) => b.total - a.total || b.gold - a.gold || b.silver - a.silver);
        }

        function renderMonthlyMedals() {
            const { months, rankings } = getMonthlyMedals();
            document.getElementById('monthlyMedals').innerHTML = months.map(month => `
                <div class="month-medal-card">
                    <h3>${getMonthName(month)}</h3>
                    ${rankings[month].map(entry => `
                        <div class="medal-row">
                            <span class="medal-icon">${entry.medal}</span>
                            <span class="medal-name">${entry.name}</span>
                            <span class="medal-distance">${entry.distance.toFixed(2)} km</span>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function renderMedalSummary() {
            const data = getMedalSummary();
            document.getElementById('medalSummary').innerHTML = data.map(d => `
                <div class="medal-summary-card">
                    <div class="name">${d.name}</div>
                    <div class="medals">${'ğŸ…'.repeat(d.gold)}${'ğŸ¥ˆ'.repeat(d.silver)}${'ğŸ¥‰'.repeat(d.bronze)}</div>
                    <div class="total">${d.gold}é‡‘ ${d.silver}é“¶ ${d.bronze}é“œ</div>
                </div>
            `).join('');
        }

        // ============== å…¶ä»–åŠŸèƒ½ ==============
        function toggleDataTable() {
            const header = document.querySelector('.collapsible-header');
            const content = document.getElementById('dataTableContent');

            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');

            if (!content.classList.contains('collapsed')) {
                content.style.maxHeight = content.scrollHeight + 'px';
            } else {
                content.style.maxHeight = '0';
            }
        }

        function exportToImage() {
            const btn = document.querySelector('.export-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ å¯¼å‡ºä¸­...';
            btn.disabled = true;

            btn.style.display = 'none';
            document.querySelector('.add-data-btn').style.display = 'none';
            document.querySelector('.batch-import-btn').style.display = 'none';
            document.querySelector('.config-btn').style.display = 'none';
            document.getElementById('connectionStatus').style.display = 'none';

            html2canvas(document.getElementById('mainContainer'), {
                backgroundColor: null,
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `è·‘æ­¥æ•°æ®ç»Ÿè®¡_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                btn.style.display = 'block';
                document.querySelector('.add-data-btn').style.display = 'block';
                document.querySelector('.batch-import-btn').style.display = 'block';
                document.querySelector('.config-btn').style.display = 'block';
                document.getElementById('connectionStatus').style.display = 'block';
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                console.error('å¯¼å‡ºå¤±è´¥:', err);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                btn.style.display = 'block';
                document.querySelector('.add-data-btn').style.display = 'block';
                document.querySelector('.batch-import-btn').style.display = 'block';
                document.querySelector('.config-btn').style.display = 'block';
                document.getElementById('connectionStatus').style.display = 'block';
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // æ¸²æŸ“æ‰€æœ‰å†…å®¹
        function renderAll() {
            // é‡ç½®ç­›é€‰å™¨çŠ¶æ€
            filterState.stacked = {};
            filterState.trend = {};
            document.getElementById('stackedFilter').innerHTML = '';
            document.getElementById('trendFilter').innerHTML = '';

            renderStatsSummary();
            renderWeeklyGoalStats();
            renderMonthlyMedals();
            renderMedalSummary();
            renderWeeklyStackedChart();
            renderTotalDistanceChart();
            renderRunCountChart();
            renderWeeklyTrendChart();
            createMonthFilter();
            createPersonFilter();
            renderDataTable();
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('addDataModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddDataModal();
        });
        document.getElementById('batchImportModal').addEventListener('click', function(e) {
            if (e.target === this) closeBatchImportModal();
        });
        document.getElementById('configModal').addEventListener('click', function(e) {
            if (e.target === this) closeConfigModal();
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
